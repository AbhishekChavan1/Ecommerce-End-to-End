{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-shopping-cart"></i> Shopping Cart</h2>
            
            {% if cart and not cart.is_empty() %}
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in cart.items %}
                                    <tr class="cart-item">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if item.product.image_filename %}
                                                    {% if item.product.image_filename.startswith('http') %}
                                                        <img src="{{ item.product.image_filename }}" 
                                                             alt="{{ item.product.name }}" class="me-3" 
                                                             style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% else %}
                                                        <img src="{{ url_for('static', filename='uploads/' + item.product.image_filename) }}" 
                                                             alt="{{ item.product.name }}" class="me-3" 
                                                             style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% endif %}
                                                {% else %}
                                                    <div class="bg-light me-3 d-flex align-items-center justify-content-center" 
                                                         style="width: 50px; height: 50px;">
                                                        <i class="fas fa-image text-muted"></i>
                                                    </div>
                                                {% endif %}
                                                <div>
                                                    <h6 class="mb-0">{{ item.product.name }}</h6>
                                                    <small class="text-muted">{{ item.product.category.name }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>${{ "%.2f"|format(item.price) }}</td>
                                        <td>
                                            <form method="POST" action="{{ url_for('shop.update_cart') }}" class="d-flex align-items-center">
                                                <input type="hidden" name="product_id" value="{{ item.product_id }}">
                                                <input type="number" name="quantity" value="{{ item.quantity }}" 
                                                       min="0" max="99" class="form-control form-control-sm me-2" 
                                                       style="width: 80px;" onchange="this.form.submit()">
                                                <button type="submit" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                            </form>
                                        </td>
                                        <td class="fw-bold">${{ "%.2f"|format(item.get_total_price()) }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('shop.remove_from_cart', product_id=item.product_id) }}" 
                                                   class="btn btn-sm btn-outline-danger"
                                                   title="Remove from cart">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                                <a href="{{ url_for('shop.product_detail', id=item.product_id) }}" 
                                                   class="btn btn-sm btn-outline-info"
                                                   title="View product details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Cart Summary -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="d-flex flex-column flex-md-row gap-2">
                                    <a href="{{ url_for('shop.products') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-arrow-left"></i> Continue Shopping
                                    </a>
                                    <a href="{{ url_for('shop.clear_cart') }}" 
                                       class="btn btn-outline-danger"
                                       onclick="return confirm('Are you sure you want to remove all items from your cart?')">
                                        <i class="fas fa-trash-alt"></i> Clear Cart
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title">Cart Summary</h5>
                                        <div class="d-flex justify-content-between">
                                            <span>Subtotal ({{ cart.get_total_items() }} items):</span>
                                            <span class="fw-bold">${{ "%.2f"|format(cart.get_total_amount()) }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Shipping:</span>
                                            <span>Free</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <strong>Total:</strong>
                                            <strong class="text-primary">${{ "%.2f"|format(cart.get_total_amount()) }}</strong>
                                        </div>
                                        
                                        <div class="mt-3">
                                            {% if current_user.is_authenticated %}
                                                <a href="{{ url_for('shop.checkout') }}" class="btn btn-primary w-100">
                                                    <i class="fas fa-credit-card"></i> Proceed to Checkout
                                                </a>
                                            {% else %}
                                                <p class="text-muted text-center">Please log in to checkout</p>
                                                <a href="{{ url_for('auth.login') }}" class="btn btn-primary w-100">
                                                    <i class="fas fa-sign-in-alt"></i> Login to Checkout
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- Empty Cart -->
                <div class="text-center py-5">
                    <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                    <h3>Your cart is empty</h3>
                    <p class="text-muted">Add some products to get started!</p>
                    <a href="{{ url_for('shop.products') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-shopping-bag"></i> Start Shopping
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% block scripts %}
<script>
// Enhanced cart functionality
document.addEventListener('DOMContentLoaded', function() {
    const quantityInputs = document.querySelectorAll('input[name="quantity"]');
    const removeButtons = document.querySelectorAll('a[href*="remove_from_cart"]');
    
    // Auto-update cart when quantity changes
    quantityInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value < 0) this.value = 0;
            if (this.value > 99) this.value = 99;
            
            // Show loading indicator
            this.style.opacity = '0.5';
            const updateBtn = this.parentElement.querySelector('button[type="submit"]');
            if (updateBtn) {
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                updateBtn.disabled = true;
            }
        });
        
        // Re-enable after form submission
        input.closest('form').addEventListener('submit', function() {
            setTimeout(() => {
                input.style.opacity = '1';
                const updateBtn = this.querySelector('button[type="submit"]');
                if (updateBtn) {
                    updateBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                    updateBtn.disabled = false;
                }
            }, 1000);
        });
    });
    
    // Enhanced remove confirmation with animation
    removeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const productName = this.closest('tr').querySelector('h6').textContent;
            
            // Create custom confirmation modal
            const confirmed = confirm(`Are you sure you want to remove "${productName}" from your cart?`);
            
            if (confirmed) {
                // Add fade out animation
                const row = this.closest('tr');
                row.style.transition = 'opacity 0.3s ease';
                row.style.opacity = '0.5';
                
                // Show loading state
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                this.classList.add('disabled');
                
                // Navigate to remove URL
                window.location.href = this.href;
            }
        });
    });
    
    // Add smooth scroll to cart summary on mobile
    const checkoutBtn = document.querySelector('a[href*="checkout"]');
    if (checkoutBtn && window.innerWidth <= 768) {
        checkoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelector('.card.bg-light').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
            setTimeout(() => {
                window.location.href = this.href;
            }, 500);
        });
    }
    
    // Auto-save cart state to localStorage for recovery
    function saveCartState() {
        const cartItems = [];
        document.querySelectorAll('.cart-item').forEach(row => {
            const productId = row.querySelector('input[name="product_id"]').value;
            const quantity = row.querySelector('input[name="quantity"]').value;
            const productName = row.querySelector('h6').textContent;
            cartItems.push({ productId, quantity, productName });
        });
        localStorage.setItem('cartState', JSON.stringify(cartItems));
    }
    
    // Save cart state when quantities change
    quantityInputs.forEach(input => {
        input.addEventListener('change', saveCartState);
    });
    
    // Initial save
    saveCartState();
});

// Utility function to show toast notifications
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        <button type="button" class="btn-close float-end" aria-label="Close"></button>
        ${message}
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
    
    // Close button functionality
    toast.querySelector('.btn-close').addEventListener('click', () => {
        toast.remove();
    });
}
</script>
{% endblock %}
{% endblock %}